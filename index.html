<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCD70a-QR2nJnHBnA-FUoIGHZ7Z3VByPMk",
        authDomain: "le-malicieux-v2.firebaseapp.com",
        projectId: "le-malicieux-v2",
        storageBucket: "le-malicieux-v2.firebasestorage.app",
        messagingSenderId: "938147445933",
        appId: "1:938147445933:web:86f9c65ee0737e66a9da24"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let allAnimes = [];
    let userPlaylist = {};

    document.getElementById('main-body').style.setProperty('--bg-day', `url('img/fond1.jpg')`);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            const q = query(collection(db, "playlists"), where("uid", "==", user.uid));
            onSnapshot(q, (snapshot) => {
                userPlaylist = {};
                snapshot.forEach(doc => { userPlaylist[doc.data().anime] = doc.data(); });
                displayAnimes(allAnimes);
            });
        }
    });

    // Fonction de mise à jour / Ajout / Suppression
    window.updateAnime = async function(name, status, rating) {
        const user = auth.currentUser;
        if (!user) return alert("Connectez-vous pour gérer votre playlist !");
        const docRef = doc(db, "playlists", `${user.uid}_${name}`);
        if (status === 'none') {
            await deleteDoc(docRef);
        } else {
            await setDoc(docRef, {
                uid: user.uid, anime: name, status: status,
                rating: parseInt(rating) || 0, updatedAt: serverTimestamp()
            });
        }
    };

    // (Gardez vos fonctions init() et setRandomBackground() identiques)

    function displayAnimes(list) {
        const container = document.getElementById('anime-container');
        container.innerHTML = "";
        list.forEach(a => {
            const userData = userPlaylist[a.nom] || { status: 'none', rating: 0 };
            const statusBadge = userData.status !== 'none' ? `<div class="status-badge">${userData.status.toUpperCase()}</div>` : "";

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                ${statusBadge}
                <a href="video.html?name=${encodeURIComponent(a.nom)}">
                    <img src="img/${a.img}" onerror="this.src='https://via.placeholder.com/170x230'">
                </a>
                <div class="card-info">
                    <div class="card-title">${a.nom}</div>
                    <select onchange="updateAnime('${a.nom}', this.value, ${userData.rating})" style="width:100%; font-size:10px; background:#111; color:white; border:1px solid #444; margin-top:5px;">
                        <option value="none" ${userData.status === 'none' ? 'selected' : ''}>➕ Ajouter/Modifier</option>
                        <option value="en-attente" ${userData.status === 'en-attente' ? 'selected' : ''}>⏳ En attente</option>
                        <option value="vu" ${userData.status === 'vu' ? 'selected' : ''}>✅ Vu</option>
                        <option value="pas-vu" ${userData.status === 'pas-vu' ? 'selected' : ''}>❌ Pas vu</option>
                    </select>
                    <div style="display:flex; align-items:center; gap:5px; margin-top:5px; font-size:10px;">
                        Note: <input type="number" min="0" max="10" value="${userData.rating}" 
                        onchange="updateAnime('${a.nom}', '${userData.status}', this.value)" 
                        style="width:30px; background:#111; color:white; border:1px solid #444;"> <span style="color:#f1c40f;">★</span>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }
    // ... reste du script (sort, search, toggleTheme)
</script>
