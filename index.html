<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Collection d'Animes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --accent: #e50914; --bg: #0b0b0b; --card: #161616; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: var(--accent); letter-spacing: 2px; text-transform: uppercase; }

        .controles { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 30px; }
        #barreRecherche { padding: 12px 20px; width: 100%; max-width: 450px; border-radius: 25px; border: 1px solid #333; background: #1a1a1a; color: white; outline: none; transition: 0.3s; }
        #barreRecherche:focus { border-color: var(--accent); }
        
        .tri-container { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; font-size: 0.9em; color: #888; }
        select { padding: 8px 15px; border-radius: 20px; background: #222; color: white; border: 1px solid #444; cursor: pointer; outline: none; }

        .grille { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
        
        .carte { background: var(--card); border-radius: 12px; cursor: pointer; transition: 0.3s; border: 1px solid #222; overflow: hidden; position: relative; }
        .carte:hover { transform: translateY(-5px); border-color: var(--accent); }
        .carte img { width: 100%; height: 260px; object-fit: cover; background: #222; }
        
        .infos-mini { padding: 10px; text-align: center; font-weight: bold; font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .score-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.85); color: #ffcc00; padding: 4px 8px; border-radius: 8px; font-weight: bold; font-size: 0.8em; z-index: 2; }

        /* Modale (Fenêtre détails) */
        #modale { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); }
        .modale-contenu { background: #181818; margin: 5% auto; padding: 30px; border-radius: 20px; max-width: 700px; position: relative; display: flex; gap: 25px; border: 1px solid #333; }
        .close { position: absolute; right: 20px; top: 15px; font-size: 30px; cursor: pointer; color: #666; }
        
        .badge { background: #333; padding: 5px 12px; border-radius: 6px; font-size: 0.75em; text-transform: uppercase; }
        .censure-tag { color: #ff4444; border: 1px solid #ff4444; }

        @media (max-width: 600px) { 
            .modale-contenu { flex-direction: column; margin: 0; height: 100%; overflow-y: auto; border-radius: 0; padding: 20px; } 
            .modale-contenu img { width: 100% !important; height: auto !important; }
        }
    </style>
</head>
<body>

<header>
    <h1>Ma Liste Anime</h1>
    <div class="controles">
        <input type="text" id="barreRecherche" onkeyup="filtrer()" placeholder="Rechercher un titre...">
        
        <div class="tri-container">
            <span>Trier par :</span>
            <select id="triSelect" onchange="trierAnimes()">
                <option value="nom">Nom (A-Z)</option>
                <option value="popularite">Popularité (Rang)</option>
                <option value="score">Score (Meilleures notes)</option>
                <option value="sortie">Année de Sortie</option>
                <option value="nombre episodes">Épisodes</option>
                <option value="censure">Censure</option>
                <option value="etat">État</option>
            </select>
        </div>
    </div>
</header>

<div id="conteneur" class="grille">Chargement de la collection...</div>

<div id="modale">
    <div class="modale-contenu">
        <span class="close" onclick="fermer()">&times;</span>
        <img id="modale-img" style="width: 220px; border-radius: 12px; object-fit: cover;">
        <div>
            <h2 id="modale-titre" style="margin-top:0; color: var(--accent);"></h2>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                <span id="modale-sortie" class="badge"></span>
                <span id="modale-ep" class="badge"></span>
                <span id="modale-etat" class="badge"></span>
                <span id="modale-censure" class="badge"></span>
            </div>
            <p id="modale-desc" style="line-height: 1.5; color: #ccc; font-size: 0.9em; white-space: pre-wrap;"></p>
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #333;">
                <p>Note : <span id="modale-score" style="color:#ffcc00; font-weight:bold;"></span>/10</p>
                <p style="font-size: 0.8em; color: #777;">Rang Popularité : #<span id="modale-pop"></span></p>
            </div>
        </div>
    </div>
</div>

<script>
    let listAnimes = [];

    // Moteur de recherche d'images (Plan B si pas de JPG fourni)
    async function searchPoster(title) {
        try {
            const r = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(title)}&limit=1`);
            const d = await r.json();
            return d.data[0].images.jpg.large_image_url;
        } catch(e) { return 'https://via.placeholder.com/225x320?text=Image+Introuvable'; }
    }

    // Fonction d'affichage
    async function afficherCartes(data) {
        const target = document.getElementById("conteneur");
        target.innerHTML = "";

        for (let a of data) {
            if (!a.nom) continue;
            let card = document.createElement("div");
            card.className = "carte";
            let tempId = "img-" + Math.random().toString(36).substr(2, 7);
            
            // Logique de l'image : Manuel (dossier images/) ou Automatique
            let cheminImage = (a.image_url && a.image_url.trim() !== "") 
                ? "images/" + a.image_url 
                : "https://via.placeholder.com/225x320?text=Chargement...";

            card.innerHTML = `
                <div class="score-badge">★ ${a.score || '?'}</div>
                <img src="${cheminImage}" id="${tempId}" loading="lazy">
                <div class="infos-mini">${a.nom}</div>
            `;
            
            card.onclick = () => showDetails(a, document.getElementById(tempId).src);
            target.appendChild(card);
            
            // Si pas d'image manuelle, on lance la recherche auto avec un petit délai
            if (!a.image_url || a.image_url.trim() === "") {
                await new Promise(r => setTimeout(r, 400)); // Évite de saturer l'API
                searchPoster(a.nom).then(url => {
                    const img = document.getElementById(tempId);
                    if(img) img.src = url;
                });
            }
        }
    }

    Papa.parse("animes.csv", {
        download: true, header: true, skipEmptyLines: true,
        complete: function(res) {
            listAnimes = res.data;
            trierAnimes(); 
        }
    });

    function trierAnimes() {
        const critere = document.getElementById("triSelect").value;
        listAnimes.sort((a, b) => {
            let valA = a[critere] || "";
            let valB = b[critere] || "";
            if (["score", "popularite", "nombre episodes", "sortie"].includes(critere)) {
                return parseFloat(valB.toString().replace(',','.')) - parseFloat(valA.toString().replace(',','.'));
            }
            return valA.toString().localeCompare(valB.toString());
        });
        afficherCartes(listAnimes);
    }

    function showDetails(a, img) {
        document.getElementById("modale").style.display = "block";
        document.getElementById("modale-titre").innerText = a.nom;
        document.getElementById("modale-img").src = img;
        document.getElementById("modale-desc").innerText = a.description || "Aucune description.";
        document.getElementById("modale-sortie").innerText = a.sortie || "?";
        document.getElementById("modale-ep").innerText = (a["nombre episodes"] || "?") + " EPS";
        document.getElementById("modale-etat").innerText = a.etat || "?";
        document.getElementById("modale-score").innerText = a.score || "?";
        document.getElementById("modale-pop").innerText = a.popularite || "?";
        
        const cns = document.getElementById("modale-censure");
        cns.innerText = "Censure : " + (a.censure || "Non");
        cns.className = (a.censure && a.censure.toLowerCase().includes("oui")) ? "badge censure-tag" : "badge";
        
        window.history.pushState({modaleOuverte: true}, "");
    }

    function fermer() { document.getElementById("modale").style.display = "none"; }
    window.onpopstate = () => fermer();
    window.onclick = (e) => { if(e.target == document.getElementById("modale")) { fermer(); history.back(); } }

    function filtrer() {
        let val = document.getElementById("barreRecherche").value.toLowerCase();
        document.querySelectorAll(".carte").forEach(c => {
            c.style.display = c.innerText.toLowerCase().includes(val) ? "" : "none";
        });
    }
</script>
</body>
</html>
