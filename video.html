<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionnage - Le Malicieux</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --card-bg: #1a1a1a; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .back-btn { display: inline-block; text-decoration: none; color: var(--primary); font-weight: bold; margin-bottom: 20px; border: 1px solid var(--primary); padding: 8px 15px; border-radius: 6px; transition: 0.3s; }
        .back-btn:hover { background: var(--primary); color: white; }
        .anime-header { background: var(--card-bg); padding: 25px; border-radius: 15px; border: 1px solid #333; margin-bottom: 30px; }
        .top-info { display: flex; gap: 25px; margin-bottom: 25px; }
        .poster { width: 280px; flex-shrink: 0; }
        .poster img { width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .main-details { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .anime-title { font-size: 2.2em; color: var(--primary); margin: 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .stat-item { background: #222; padding: 10px; border-radius: 8px; border: 1px solid #333; text-align: center; }
        .stat-item small { color: var(--primary); font-size: 0.7em; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .stat-item span { font-weight: bold; font-size: 0.9em; }
        .bottom-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .playlist-box { background: #222; padding: 15px; border-radius: 10px; border: 1px solid #444; }
        .playlist-box select { background: #333; color: white; border: 1px solid #555; padding: 10px; border-radius: 4px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        .link-box { background: rgba(255, 71, 87, 0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(255, 71, 87, 0.3); display: flex; flex-direction: column; }
        .link-title { font-size: 0.8em; font-weight: bold; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; }
        .btn-link { display: block; background: #333; color: white; text-decoration: none; padding: 10px; border-radius: 5px; margin-bottom: 8px; font-size: 0.9em; text-align: center; border: 1px solid #444; transition: 0.3s; width: 100%; box-sizing: border-box; font-weight: bold; }
        .btn-link:hover { background: var(--primary); border-color: var(--primary); transform: translateY(-2px); }
        .star-rating { font-size: 1.5em; color: #444; cursor: pointer; margin: 10px 0; text-align: center; display: flex; justify-content: center; }
        .star-rating span.active { color: #f1c40f; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
        @media (max-width: 800px) { .top-info { flex-direction: column; align-items: center; } .poster { width: 100%; max-width: 300px; } .bottom-controls { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">‚Üê Retour au catalogue</a>
        <div id="anime-details">Chargement...</div>
        <div id="comments-section" style="margin-top:20px; background:var(--card-bg); padding:20px; border-radius:15px; border: 1px solid #333;">
            <h3>Commentaires</h3>
            <textarea id="comment-input" style="width: 100%; background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; resize: none; box-sizing: border-box;" placeholder="Ajouter un commentaire..." rows="3"></textarea>
            <button id="btn-post" class="btn-save" style="width: auto; padding: 10px 30px;">Publier</button>
            <div id="comments-display" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, addDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyCD70a-QR2nJnHBnA-FUoIGHZ7Z3VByPMk", authDomain: "le-malicieux-v2.firebaseapp.com", projectId: "le-malicieux-v2", storageBucket: "le-malicieux-v2.firebasestorage.app", messagingSenderId: "938147445933", appId: "1:938147445933:web:86f9c65ee0737e66a9da24" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const params = new URLSearchParams(window.location.search);
        const animeName = params.get('name');
        let currentUser = null;
        let userRating = 0;

        async function load() {
            const display = document.getElementById('anime-details');
            try {
                const resp = await fetch('animes.csv');
                const data = await resp.text();
                const lines = data.split(/\r?\n/).slice(1);
                
                const anime = lines.map(l => {
                    const c = l.split(';'); 
                    const cl = (s) => s ? s.trim().replace(/^"|"$/g, '') : "";
                    if(cl(c[0]) === animeName) {
                        return { nom: cl(c[0]), pop: cl(c[1]), score: cl(c[2]), year: cl(c[3]), epRaw: cl(c[4]), censure: cl(c[5]), etat: cl(c[6]), desc: cl(c[7]), img: cl(c[8]), streamLinks: c[9] ? c[9].split(',').map(cl) : [], downloadLinks: c[10] ? c[10].split(',').map(cl) : [], visionnageInfo: cl(c[11]) };
                    }
                }).find(x => x);

                if(!anime) { display.innerHTML = "Anime non trouv√©."; return; }

                // Extraction pour le menu d√©roulant : on cherche le chiffre entre parenth√®ses OU le premier chiffre venu
                const match = anime.epRaw.match(/\((\d+)\)/) || anime.epRaw.match(/(\d+)/);
                const maxEp = match ? parseInt(match[1]) : 0;
                let epOptions = "";
                for(let i=0; i <= maxEp; i++) { epOptions += `<option value="${i}">${i}</option>`; }

                display.innerHTML = `
                    <div class="anime-header">
                        <div class="top-info">
                            <div class="poster"><img src="img/${anime.img.split('.')[0]}.jpg" onerror="this.src='img/${anime.img.split('.')[0]}.png'"></div>
                            <div class="main-details">
                                <h1 class="anime-title">${anime.nom}</h1>
                                <div class="stats-grid">
                                    <div class="stat-item"><small>Pop.</small><span>${anime.pop}</span></div>
                                    <div class="stat-item"><small>Score</small><span>‚≠ê ${anime.score}</span></div>
                                    <div class="stat-item"><small>Ann√©e</small><span>${anime.year}</span></div>
                                    <div class="stat-item"><small>√âpisodes</small><span>${anime.epRaw}</span></div>
                                    <div class="stat-item"><small>Censure</small><span>${anime.censure}</span></div>
                                    <div class="stat-item"><small>√âtat</small><span>${anime.etat}</span></div>
                                </div>
                                <p style="line-height:1.5; color:#ccc; margin:0; font-size:0.9em;">${anime.desc}</p>
                            </div>
                        </div>
                        <div class="bottom-controls">
                            <div class="playlist-box">
                                <label style="font-size:0.75em; color:var(--primary); font-weight:bold; text-transform:uppercase; display:block; margin-bottom:10px;">Ma Liste</label>
                                <select id="user-status"><option value="watching">En cours</option><option value="waiting">En attente</option><option value="completed">Termin√©</option></select>
                                <select id="target-playlist"><option value="">Chargement...</option></select>
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; background:#333; padding:5px 10px; border-radius:4px; border:1px solid #555;">
                                    <span style="font-size:0.85em; color:#888;">Vu :</span>
                                    <select id="user-ep" style="background:transparent; border:none; color:white; padding:5px; flex:1;">${epOptions}</select>
                                    <span style="font-size:0.85em; color:#888;">/ ${maxEp}</span>
                                </div>
                                <div class="star-rating" id="stars">${Array.from({length:10}, (_,i)=>`<span data-v="${i+1}">‚òÖ</span>`).join('')}</div>
                                <button class="btn-save" id="save-btn">Mettre √† jour</button>
                                <button id="delete-btn" style="background:none; border:1px solid #ff4757; color:#ff4757; margin-top:10px; padding:5px; width:100%; cursor:pointer; border-radius:4px; font-size:0.8em;">Retirer de ma liste</button>
                            </div>
                            <div class="link-box">
                                <div class="link-title">üì• T√©l√©chargement</div>
                                <div id="dl-area" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;"></div>
                                <div class="link-title">üé¨ Visionnage</div>
                                <div style="background:rgba(255,255,255,0.05); border-left: 3px solid var(--primary); padding:10px; border-radius:4px; font-size:0.85em; margin-bottom:10px; color:#bbb;">${anime.visionnageInfo || "Aucune info."}</div>
                                <div id="stream-area" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;"></div>
                                <div style="margin-top:auto; padding-top:15px; font-size:0.75em; color:#777; line-height:1.4; font-style: italic; border-top: 1px solid #333;">
                                    Note: Quand une ≈ìuvre poss√®de plusieurs saisons sous le m√™me nom, une seule carte est cr√©√©e. Le slash (/) s√©pare les infos des diff√©rentes saisons.
                                </div>
                            </div>
                        </div>
                    </div>`;

                const dlArea = document.getElementById('dl-area');
                anime.downloadLinks.filter(l => l).forEach((link, i) => { dlArea.innerHTML += `<a href="${link}" target="_blank" class="btn-link">Lien ${i+1}</a>`; });
                const streamArea = document.getElementById('stream-area');
                anime.streamLinks.filter(l => l).forEach((link, i) => { streamArea.innerHTML += `<a href="${link}" target="_blank" class="btn-link">Lecteur ${i+1} ‚Üó</a>`; });

                onAuthStateChanged(auth, async (u) => {
                    currentUser = u;
                    if(u) {
                        onSnapshot(query(collection(db, "playlists_custom"), where("uid", "==", u.uid)), (snap) => {
                            const sel = document.getElementById('target-playlist');
                            sel.innerHTML = snap.empty ? '<option value="">(Par d√©faut)</option>' : '';
                            snap.forEach(d => sel.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`);
                        });
                        const docRef = doc(db, "playlists", u.uid + "_" + anime.nom);
                        const docSnap = await getDoc(docRef);
                        if(docSnap.exists()) {
                            const d = docSnap.data();
                            document.getElementById('user-status').value = d.status;
                            document.getElementById('user-ep').value = d.epSeen;
                            userRating = d.rating || 0;
                            updateStars(userRating);
                            setTimeout(() => { if(d.playlistTarget) document.getElementById('target-playlist').value = d.playlistTarget; }, 500);
                        }
                        document.getElementById('save-btn').onclick = () => {
                            setDoc(docRef, { uid: u.uid, anime: anime.nom, img: anime.img, status: document.getElementById('user-status').value, epSeen: parseInt(document.getElementById('user-ep').value), rating: userRating, playlistTarget: document.getElementById('target-playlist').value, epMax: maxEp }).then(() => alert("Sauvegard√© !"));
                        };
                        document.getElementById('delete-btn').onclick = () => { if(confirm("Retirer ?")) deleteDoc(docRef).then(() => location.reload()); };
                    }
                });

                const updateStars = (v) => document.querySelectorAll('#stars span').forEach(s => s.classList.toggle('active', s.dataset.v <= v));
                document.getElementById('stars').onclick = (e) => { if(e.target.dataset.v) { userRating = parseInt(e.target.dataset.v); updateStars(userRating); } };

                onSnapshot(query(collection(db, "commentaires"), where("anime", "==", animeName)), (snap) => {
                    const cDisp = document.getElementById('comments-display');
                    const docs = [];
                    snap.forEach(d => docs.push(d.data()));
                    docs.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
                    cDisp.innerHTML = docs.map(d => `<div style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;"><b style="color:var(--primary)">${d.userName}</b> <p style="margin:5px 0; font-size:0.9em;">${d.text}</p></div>`).join('');
                });

                document.getElementById('btn-post').onclick = async () => {
                    if(!currentUser) return alert("Connectez-vous !");
                    const txt = document.getElementById('comment-input').value;
                    if(txt.trim()) { await addDoc(collection(db, "commentaires"), { anime: animeName, text: txt, userName: currentUser.displayName, date: serverTimestamp() }); document.getElementById('comment-input').value = ""; }
                };
            } catch (err) { 
                console.error(err); 
                display.innerHTML = "Erreur fatale lors du chargement. V√©rifiez la console F12."; 
            }
        }
        load();
    </script>
</body>
</html>
