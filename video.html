<!DOCTYPE html>
<html lang="fr">
<head>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M65SBS3C');</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Visionnage - Le Malicieux</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --card-bg: #1a1a1a; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .back-btn { display: inline-block; text-decoration: none; color: var(--primary); font-weight: bold; margin-bottom: 20px; border: 1px solid var(--primary); padding: 8px 15px; border-radius: 6px; transition: 0.3s; }
        .back-btn:hover { background: var(--primary); color: white; }
        
        .anime-header { background: var(--card-bg); padding: 25px; border-radius: 15px; border: 1px solid #333; margin-bottom: 30px; }
        .top-info { display: flex; gap: 25px; margin-bottom: 25px; flex-wrap: wrap; }
        .poster { width: 180px; border-radius: 10px; border: 2px solid #333; }
        .details h1 { margin: 0 0 10px 0; color: var(--primary); font-size: 2em; }
        .tag-info { background: #333; padding: 4px 10px; border-radius: 5px; font-size: 0.85em; margin-right: 8px; font-weight: bold; }

        .player-section { background: #000; border-radius: 15px; overflow: hidden; aspect-ratio: 16/9; margin-bottom: 30px; border: 1px solid #333; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }

        .controls { display: flex; justify-content: center; gap: 15px; padding: 15px; background: #111; border-top: 1px solid #333; flex-wrap: wrap; }
        .btn { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn:hover { background: #444; transform: scale(1.05); }
        .btn-main { background: var(--primary); }
        .btn-main:hover { background: #ff6b81; }

        .ep-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px; max-height: 250px; overflow-y: auto; padding: 10px; background: #0a0a0a; border-radius: 10px; border: 1px solid #333; }
        .ep-btn { background: #222; border: 1px solid #444; color: white; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .ep-btn:hover { border-color: var(--primary); color: var(--primary); }
        .ep-btn.active { background: var(--primary); border-color: var(--primary); }

        .playlist-ui { background: var(--card-bg); padding: 20px; border-radius: 15px; border: 1px solid #333; margin-top: 20px; }
        #stars span { font-size: 28px; cursor: pointer; color: #444; margin-right: 5px; }
        #stars span.active { color: #f1c40f; }
        .status-select { background: #222; color: white; border: 1px solid #444; padding: 8px; border-radius: 5px; }

        .comments-section { margin-top: 40px; background: var(--card-bg); padding: 25px; border-radius: 15px; border: 1px solid #333; }
        #comment-input { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
        
        @media (max-width: 600px) { .top-info { justify-content: center; text-align: center; } .poster { width: 140px; } }
    </style>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M65SBS3C"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <div class="container">
        <a href="index.html" class="back-btn">‚Üê Retour au catalogue</a>

        <div id="anime-header" class="anime-header">Chargement...</div>

        <div class="player-section">
            <iframe id="video-frame" allowfullscreen sandbox="allow-forms allow-pointer-lock allow-same-origin allow-scripts allow-top-navigation"></iframe>
        </div>

        <div class="controls">
            <button class="btn btn-main" onclick="changeEp(-1)">Pr√©c√©dent</button>
            <div id="ep-title" style="font-weight:bold; padding:10px;">√âpisode 1</div>
            <button class="btn btn-main" onclick="changeEp(1)">Suivant</button>
            <button class="btn" onclick="togglePlaylist()">‚ûï Ajouter √† ma playlist</button>
        </div>

        <div id="playlist-box" class="playlist-ui" style="display:none;">
            <h3>G√©rer l'anime</h3>
            <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
                <div>
                    √âtat : 
                    <select id="status-select" class="status-select">
                        <option value="watching">En cours</option>
                        <option value="completed">Termin√©</option>
                        <option value="waiting">En attente</option>
                    </select>
                </div>
                <div>
                    Ma note : 
                    <div id="stars">
                        <span data-v="1">‚òÖ</span><span data-v="2">‚òÖ</span><span data-v="3">‚òÖ</span><span data-v="4">‚òÖ</span><span data-v="5">‚òÖ</span><span data-v="6">‚òÖ</span><span data-v="7">‚òÖ</span><span data-v="8">‚òÖ</span><span data-v="9">‚òÖ</span><span data-v="10">‚òÖ</span>
                    </div>
                </div>
                <div>Playlist : <select id="target-playlist" class="status-select"></select></div>
                <button id="btn-save" class="btn btn-main">Enregistrer les changements</button>
            </div>
        </div>

        <h3 style="margin-top:30px;">√âpisodes</h3>
        <div id="episodes-grid" class="ep-grid"></div>

        <div class="comments-section">
            <h3>Commentaires</h3>
            <div id="auth-check-comment" style="display:none; color:#888; margin-bottom:15px;">Connectez-vous pour commenter.</div>
            <div id="comment-form">
                <textarea id="comment-input" rows="3" placeholder="Qu'en as-tu pens√© ?"></textarea>
                <button id="btn-post" class="btn btn-main">Publier le commentaire</button>
            </div>
            <div id="comments-display" style="margin-top:25px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, addDoc, doc, updateDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyCD70a-QR2nJnHBnA-FUoIGHZ7Z3VByPMk", authDomain: "le-malicieux-v2.firebaseapp.com", projectId: "le-malicieux-v2", storageBucket: "le-malicieux-v2.firebasestorage.app", messagingSenderId: "938147445933", appId: "1:938147445933:web:86f9c65ee0737e66a9da24" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const urlParams = new URLSearchParams(window.location.search);
        const animeName = urlParams.get('name');
        let currentEp = 1;
        let totalEp = 0;
        let currentUser = null;
        let existingDocId = null;
        let userRating = 0;

        window.changeEp = (dir) => {
            const next = currentEp + dir;
            if(next >= 1 && next <= totalEp) {
                currentEp = next;
                updateIframe();
            }
        };

        window.togglePlaylist = () => {
            if(!currentUser) return alert("Connectez-vous d'abord !");
            document.getElementById('playlist-box').style.display = 'block';
        };

        function updateIframe() {
            const cleanName = animeName.replace(/'/g, "").replace(/\s+/g, "-").toLowerCase();
            document.getElementById('video-frame').src = `https://vidsrc.me/embed/anime/${cleanName}/${currentEp}`;
            document.getElementById('ep-title').innerText = `√âpisode ${currentEp}`;
            document.querySelectorAll('.ep-btn').forEach((b, i) => b.classList.toggle('active', (i+1) === currentEp));
        }

        async function load() {
            try {
                const response = await fetch('animes.csv');
                const raw = await response.text();
                const anime = raw.split(/\r?\n/).slice(1).map(l => l.split(';')).find(c => c[0]?.trim().replace(/^"|"$/g, '') === animeName);
                
                if(!anime) return document.body.innerHTML = "Anime non trouv√©.";
                const cl = (s) => s ? s.trim().replace(/^"|"$/g, '') : "";
                
                totalEp = parseInt(cl(anime[4])) || 12;
                document.title = `${cl(anime[0])} - Le Malicieux`;
                document.getElementById('anime-header').innerHTML = `
                    <div class="top-info">
                        <img src="img/${cl(anime[8]).split('.')[0]}.webp" class="poster" onerror="this.src='img/${cl(anime[8]).split('.')[0]}.jpg'">
                        <div class="details">
                            <h1>${cl(anime[0])}</h1>
                            <span class="tag-info">‚≠ê ${cl(anime[2])}</span>
                            <span class="tag-info">üìÖ ${cl(anime[3])}</span>
                            <span class="tag-info">${cl(anime[5])}</span>
                            <span class="tag-info">${cl(anime[6])}</span>
                        </div>
                    </div>`;

                const grid = document.getElementById('episodes-grid');
                for(let i=1; i<=totalEp; i++) {
                    const b = document.createElement('div');
                    b.className = 'ep-btn'; b.innerText = i;
                    b.onclick = () => { currentEp = i; updateIframe(); };
                    grid.appendChild(b);
                }
                updateIframe();

                onAuthStateChanged(auth, async (user) => {
                    currentUser = user;
                    if(user) {
                        document.getElementById('comment-form').style.display = 'block';
                        document.getElementById('auth-check-comment').style.display = 'none';

                        const pSel = document.getElementById('target-playlist');
                        pSel.innerHTML = '<option value="">Aucune (D√©faut)</option>';
                        const pSnap = await getDocs(query(collection(db, "playlists_custom"), where("uid", "==", user.uid)));
                        pSnap.forEach(d => pSel.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`);

                        const q = query(collection(db, "playlists"), where("uid", "==", user.uid), where("anime", "==", animeName));
                        const snap = await getDocs(q);
                        if(!snap.empty) {
                            const d = snap.docs[0];
                            existingDocId = d.id;
                            const data = d.data();
                            document.getElementById('status-select').value = data.status || 'watching';
                            userRating = data.rating || 0;
                            updateStars(userRating);
                            pSel.value = data.playlistTarget || "";
                        }
                    } else {
                        document.getElementById('comment-form').style.display = 'none';
                        document.getElementById('auth-check-comment').style.display = 'block';
                    }
                });

                document.querySelectorAll('#stars span').forEach(s => {
                    s.onclick = () => { userRating = parseInt(s.dataset.v); updateStars(userRating); };
                });

                document.getElementById('btn-save').onclick = async () => {
                    const payload = {
                        uid: currentUser.uid, anime: animeName, img: cl(anime[8]),
                        status: document.getElementById('status-select').value,
                        rating: userRating, epSeen: currentEp,
                        playlistTarget: document.getElementById('target-playlist').value,
                        updatedAt: serverTimestamp()
                    };
                    if(existingDocId) { await updateDoc(doc(db, "playlists", existingDocId), payload); alert("Mis √† jour !"); }
                    else { await addDoc(collection(db, "playlists"), payload).then(() => location.reload()); };
                };

                const updateStars = (v) => document.querySelectorAll('#stars span').forEach(s => s.classList.toggle('active', s.dataset.v <= v));

                onSnapshot(query(collection(db, "commentaires"), where("anime", "==", animeName)), (snap) => {
                    const cDisp = document.getElementById('comments-display');
                    let docs = [];
                    snap.forEach(d => docs.push(d.data()));
                    docs.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
                    cDisp.innerHTML = docs.map(d => `<div style="margin-bottom:12px; border-bottom:1px solid #333; padding-bottom:8px;"><b style="color:var(--primary)">${d.userName}</b><p style="margin:4px 0; font-size:0.9em; color:#ddd;">${d.text}</p></div>`).join('');
                });

                document.getElementById('btn-post').onclick = async () => {
                    const t = document.getElementById('comment-input').value;
                    if(t.trim() && currentUser) { 
                        await addDoc(collection(db, "commentaires"), { anime: animeName, text: t, userName: currentUser.displayName, date: serverTimestamp() }); 
                        document.getElementById('comment-input').value = ""; 
                    }
                };

            } catch (err) { console.error(err); }
        }
        load();
    </script>
</body>
</html>
