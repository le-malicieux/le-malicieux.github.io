<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionnage - Le Malicieux</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --card-bg: #1a1a1a; --text: #eee; }
        body.light-mode { --bg: #EAEAEA; --card-bg: #FFFFFF; --text: #2d3436; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; transition: 0.3s; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { padding: 10px 18px; background: #222; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; border: 1px solid #444; }
        body.light-mode .back-btn { background: #fff; color: #333; border-color: #ccc; }

        /* Infos au-dessus */
        .details-top { display: flex; gap: 25px; background: var(--card-bg); padding: 25px; border-radius: 15px; border: 1px solid #333; margin-bottom: 25px; flex-wrap: wrap; }
        body.light-mode .details-top { border-color: #ddd; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .details-top img { width: 200px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .info-block { flex: 1; min-width: 300px; }
        h1 { color: var(--primary); margin: 0 0 10px 0; }
        .tag-row { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { background: #333; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; color: white; }
        .desc { line-height: 1.6; opacity: 0.9; white-space: pre-wrap; }

        /* Lecteur en dessous */
        .video-section { text-align: center; }
        .video-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; border: 1px solid #333; margin-top: 10px; }
        iframe { width: 100%; height: 100%; border: none; }
        .episode-selector { padding: 10px; border-radius: 6px; background: #1a1a1a; color: white; border: 1px solid var(--primary); margin-bottom: 10px; width: 200px; }
        body.light-mode .episode-selector { background: #fff; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-nav">
            <a href="index.html" class="back-btn">‚Üê Catalogue</a>
            <div id="selector-container"></div>
        </div>

        <div id="details-content"></div>

        <div class="video-section">
            <div id="video-wrapper" class="video-container">
                <p style="text-align:center; padding-top:20%;">S√©lectionnez un anime...</p>
            </div>
        </div>
    </div>

    <script>
        if(localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
        const clean = (str) => (str || "").replace(/^"|"$/g, "").trim();

        async function init() {
            const name = new URLSearchParams(window.location.search).get('name');
            try {
                const res = await fetch('animes.csv');
                const rows = (await res.text()).split(/\r?\n(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                
                let a = null;
                for(let i=1; i<rows.length; i++) {
                    let c = rowSplit(rows[i]);
                    if (clean(c[0]) === name) {
                        a = { 
                            nom: clean(c[0]), pop: clean(c[1]), score: clean(c[2]), sort: clean(c[3]),
                            eps: clean(c[4]), cens: clean(c[5]), etat: clean(c[6]), desc: clean(c[7]),
                            img: clean(c[8]), urls: clean(c[9]).split(',').filter(x => x.length > 5) 
                        };
                        break;
                    }
                }

                if(a) {
                    // Affichage des infos en haut
                    document.getElementById('details-content').innerHTML = `
                        <div class="details-top">
                            <img src="img/${a.img}" onerror="this.src='https://via.placeholder.com/200x300'">
                            <div class="info-block">
                                <h1>${a.nom}</h1>
                                <div class="tag-row">
                                    <span class="tag">‚≠ê ${a.score}/10</span>
                                    <span class="tag">üì∫ ${a.eps} √©pisodes</span>
                                    <span class="tag">üìÖ ${a.sort}</span>
                                    <span class="tag">üîû ${a.cens}</span>
                                </div>
                                <div class="desc">${a.desc}</div>
                            </div>
                        </div>`;

                    // Affichage du lecteur en bas
                    if(a.urls.length > 0) {
                        const format = (u) => u.trim().replace('/v/', '/e/');
                        document.getElementById('video-wrapper').innerHTML = `<iframe id="player" src="${format(a.urls[0])}" allowfullscreen></iframe>`;
                        if(a.urls.length > 1) {
                            let s = `<select class="episode-selector" onchange="document.getElementById('player').src=this.value">`;
                            a.urls.forEach((u, i) => s += `<option value="${format(u)}">√âpisode ${i+1}</option>`);
                            document.getElementById('selector-container').innerHTML = s + `</select>`;
                        }
                    } else {
                        document.getElementById('video-wrapper').innerHTML = `<p style="padding-top:20%;">Vid√©o bient√¥t disponible.</p>`;
                    }
                }
            } catch(e) { console.error(e); }
        }

        function rowSplit(line) {
            const result = []; let current = "", inQuotes = false;
            for (let char of line) {
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ';' && !inQuotes) { result.push(current); current = ""; }
                else current += char;
            }
            result.push(current); return result;
        }
        init();
    </script>
</body>
</html>
