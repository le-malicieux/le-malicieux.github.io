<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Malicieux - Visionnage</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --card-bg: #1a1a1a; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .back-btn { display: inline-block; text-decoration: none; color: var(--primary); font-weight: bold; margin-bottom: 20px; border: 1px solid var(--primary); padding: 8px 15px; border-radius: 6px; transition: 0.3s; }
        .back-btn:hover { background: var(--primary); color: white; }

        .anime-header { display: flex; gap: 30px; flex-wrap: wrap; background: var(--card-bg); padding: 25px; border-radius: 15px; border: 1px solid #333; margin-bottom: 30px; }
        .anime-header img { width: 280px; border-radius: 10px; border: 2px solid var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .details { flex: 1; min-width: 300px; }
        .details h1 { margin-top: 0; color: var(--primary); font-size: 2.2em; }
        
        /* Retour à la grille d'infos originale */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .info-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; border-left: 3px solid var(--primary); font-size: 0.9em; }
        .info-item strong { color: #888; display: block; font-size: 0.8em; text-transform: uppercase; }

        /* Description en dessous */
        .description-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid #333; margin-top: 15px; }
        .description-box h3 { margin-top: 0; color: var(--primary); font-size: 1em; }

        .video-player { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 15px; overflow: hidden; border: 1px solid #333; margin-bottom: 30px; }

        /* Style Commentaires */
        .comment-section { background: #999; padding: 20px; border-radius: 8px; color: white; margin-top: 20px; }
        .comment-header { background: #111; padding: 10px; text-align: center; font-weight: bold; border-radius: 5px; margin-bottom: 15px; }
        .login-box { text-align: center; margin-bottom: 15px; }
        .btn-google { background: #4285F4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #comment-form textarea { width: 100%; height: 80px; background: #666; border: none; border-radius: 5px; padding: 10px; color: white; margin-bottom: 10px; resize: none; box-sizing: border-box; }
        #comment-form button { background: #111; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; float: right; }
        .comment-list { margin-top: 50px; clear: both; }
        .comment-item { background: #777; padding: 15px; border-radius: 5px; display: flex; gap: 15px; margin-bottom: 10px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="container">
        <a href="index.html" class="back-btn">← Retour au catalogue</a>
        <div id="video-content">Chargement...</div>

        <div class="comment-section">
            <div class="comment-header">Commentaire</div>
            <div id="auth-container" class="login-box">
                <p>Tu dois te connecter pour commenter</p>
                <button class="btn-google" id="btn-login">Se connecter avec Google</button>
            </div>
            <div id="comment-form" style="display: none;">
                <textarea id="comment-input" placeholder="Ajoutez votre commentaire..."></textarea>
                <button id="btn-post">Poster</button>
            </div>
            <div id="comments-display" class="comment-list"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCulapHB1Z_8mYJeTQCIB-PSQaTRtvod7s",
            authDomain: "le-malicieux.firebaseapp.com",
            projectId: "le-malicieux",
            storageBucket: "le-malicieux.firebasestorage.app",
            messagingSenderId: "878822677925",
            appId: "1:878822677925:web:cfcba50c8249cdc0b05c4c",
            measurementId: "G-84L0BGBD75"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const animeName = new URLSearchParams(window.location.search).get('name');
        let currentUser = null;

        document.getElementById('btn-login').onclick = () => {
            signInWithPopup(auth, provider).catch(err => alert("Erreur de connexion : " + err.message));
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('comment-form').style.display = 'block';
            }
        });

        document.getElementById('btn-post').onclick = async () => {
            const text = document.getElementById('comment-input').value;
            if (!text.trim()) return;
            await addDoc(collection(db, "commentaires"), {
                anime: animeName,
                text: text,
                userName: currentUser.displayName,
                userPhoto: currentUser.photoURL,
                date: serverTimestamp()
            });
            document.getElementById('comment-input').value = "";
        };

        const q = query(collection(db, "commentaires"), where("anime", "==", animeName), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            const container = document.getElementById('comments-display');
            container.innerHTML = "";
            snapshot.forEach((doc) => {
                const data = doc.data();
                const date = data.date ? new Date(data.date.seconds * 1000).toLocaleDateString() : "Instant";
                container.innerHTML += `
                    <div class="comment-item">
                        <img src="${data.userPhoto}" class="user-avatar">
                        <div>
                            <span style="font-weight:bold">${data.userName}</span> <span style="font-size:0.8em;color:#ccc">Le ${date}</span>
                            <p style="margin:5px 0">${data.text}</p>
                            <span style="font-size:0.7em;color:#bbb;font-weight:bold">MEMBRE</span>
                        </div>
                    </div>`;
            });
        });

        async function loadAnimeDetails() {
            if (!animeName) return;
            const response = await fetch('animes.csv');
            const rawData = await response.text();
            const rows = rawData.split(/\r?\n/);
            let anime = null;
            rows.slice(1).forEach(line => {
                const c = line.split(';');
                const clean = (s) => s ? s.trim().replace(/^"|"$/g, '') : "";
                if (clean(c[0]) === animeName) {
                    anime = {
                        nom: clean(c[0]),
                        popularite: clean(c[1]) || "?",
                        score: clean(c[2]) || "0",
                        sortie: clean(c[3]) || "?",
                        episodes: clean(c[4]) || "?",
                        censure: clean(c[5]) || "?",
                        etat: clean(c[6]) || "?",
                        desc: clean(c[7]) || "Pas de description.",
                        img: clean(c[8]) || clean(c[c.length - 1])
                    };
                }
            });
            if (anime) {
                document.getElementById('video-content').innerHTML = `
                    <div class="anime-header">
                        <img src="img/${anime.img}" onerror="this.src='https://via.placeholder.com/280x400'">
                        <div class="details">
                            <h1>${anime.nom}</h1>
                            <div class="info-grid">
                                <div class="info-item"><strong>Popularité</strong>${anime.popularite}</div>
                                <div class="info-item"><strong>Score</strong>⭐ ${anime.score}/10</div>
                                <div class="info-item"><strong>Année</strong>${anime.sortie}</div>
                                <div class="info-item"><strong>Épisodes</strong>${anime.episodes}</div>
                                <div class="info-item"><strong>Censure</strong>${anime.censure}</div>
                                <div class="info-item"><strong>État</strong>${anime.etat}</div>
                            </div>
                            <div class="description-box">
                                <h3>Synopsis</h3>
                                <p>${anime.desc}</p>
                            </div>
                        </div>
                    </div>
                    <div class="video-player"><div style="display:flex;height:100%;align-items:center;justify-content:center;color:#555;">Lecteur Vidéo</div></div>
                `;
            }
        }
        loadAnimeDetails();
    </script>
</body>
</html>
