<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionnage - Le Malicieux</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --card-bg: #1a1a1a; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .back-btn { display: inline-block; text-decoration: none; color: var(--primary); font-weight: bold; margin-bottom: 20px; border: 1px solid var(--primary); padding: 8px 15px; border-radius: 6px; }
        .controls-box { background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px solid #333; margin: 20px 0; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        select, input, button { background: #111; color: white; border: 1px solid #444; padding: 8px; border-radius: 5px; }
        .btn-save { background: var(--primary); border: none; font-weight: bold; cursor: pointer; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">← Retour</a>
        <div id="anime-details"></div>
        
        <div id="playlist-manager" class="controls-box" style="display:none;">
            <strong>Ma Liste :</strong>
            <select id="p-status">
                <option value="none">-- Ajouter --</option>
                <option value="en-attente">⏳ En attente</option>
                <option value="vu">✅ Vu</option>
                <option value="pas-vu">❌ Pas vu</option>
            </select>
            <input type="number" id="p-rating" min="0" max="10" placeholder="Note /10" style="width:80px;">
            <button id="p-save" class="btn-save">Sauvegarder</button>
        </div>

        <div id="player-container" style="margin-top:30px;">
            <iframe id="main-iframe" width="100%" height="500px" frameborder="0" allowfullscreen></iframe>
            <div id="episodes-list" style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCD70a-QR2nJnHBnA-FUoIGHZ7Z3VByPMk", authDomain: "le-malicieux-v2.firebaseapp.com", projectId: "le-malicieux-v2", storageBucket: "le-malicieux-v2.firebasestorage.app", messagingSenderId: "938147445933", appId: "1:938147445933:web:86f9c65ee0737e66a9da24" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const params = new URLSearchParams(window.location.search);
        const animeName = params.get('name');

        onAuthStateChanged(auth, async (user) => {
            if (user && animeName) {
                document.getElementById('playlist-manager').style.display = 'flex';
                const docRef = doc(db, "playlists", `${user.uid}_${animeName}`);
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    document.getElementById('p-status').value = snap.data().status || "none";
                    document.getElementById('p-rating').value = snap.data().rating || 0;
                }
                document.getElementById('p-save').onclick = async () => {
                    await setDoc(docRef, { uid: user.uid, anime: animeName, status: document.getElementById('p-status').value, rating: parseInt(document.getElementById('p-rating').value) || 0, updatedAt: serverTimestamp() });
                    alert("C'est enregistré !");
                };
            }
        });

        async function load() {
            if(!animeName) return;
            const resp = await fetch('animes.csv');
            const data = await resp.text();
            const rows = data.split('\n').slice(1);
            const anime = rows.map(r => r.split(';')).find(c => c[0] && c[0].trim().replace(/^"|"$/g, '') === animeName);
            if (anime) {
                document.getElementById('anime-details').innerHTML = `<h1>${anime[0]}</h1><p>${anime[7] || ""}</p>`;
                const epLinks = anime[9].replace(/^"|"$/g, '').split(',');
                const list = document.getElementById('episodes-list');
                const iframe = document.getElementById('main-iframe');
                epLinks.forEach((link, i) => {
                    const btn = document.createElement('button');
                    btn.innerText = `EP ${i+1}`;
                    btn.onclick = () => iframe.src = link.trim();
                    list.appendChild(btn);
                    if(i===0) iframe.src = link.trim();
                });
            }
        }
        load();
    </script>
</body>
</html>
