<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Visionnage - Le Malicieux</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --card-bg: #1a1a1a; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        .back-btn { display: inline-block; text-decoration: none; color: var(--primary); font-weight: bold; margin-bottom: 20px; border: 1px solid var(--primary); padding: 8px 15px; border-radius: 6px; transition: 0.3s; }
        .back-btn:hover { background: var(--primary); color: white; }
        .anime-header { background: var(--card-bg); padding: 25px; border-radius: 15px; border: 1px solid #333; margin-bottom: 30px; }
        .top-info { display: flex; gap: 25px; margin-bottom: 25px; }
        .poster { width: 280px; flex-shrink: 0; }
        .poster img { width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .main-details { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .anime-title { font-size: 2.2em; color: var(--primary); margin: 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .stat-item { background: #222; padding: 10px; border-radius: 8px; border: 1px solid #333; text-align: center; }
        .stat-item small { color: var(--primary); font-size: 0.7em; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .stat-item span { font-weight: bold; font-size: 0.9em; }
        .bottom-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: stretch; }
        .playlist-box { background: #222; padding: 15px; border-radius: 10px; border: 1px solid #444; }
        
        .playlist-box select { 
            background: #333; color: white; border: 1px solid #555; padding: 10px; 
            border-radius: 4px; margin-bottom: 10px; width: 100%; box-sizing: border-box; 
            cursor: pointer; font-size: 0.9em;
        }
        .playlist-box select option { background: #222; color: white; }

        .ep-select-container {
            display: flex; align-items: center; gap: 8px; background: #333; 
            border: 1px solid #555; padding: 5px 12px; border-radius: 4px; margin-bottom: 10px;
        }
        #user-ep { background: transparent; border: none; color: white; flex-grow: 1; padding: 5px; cursor: pointer; }

        .link-box { background: rgba(255, 71, 87, 0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(255, 71, 87, 0.3); }
        .link-title { font-size: 0.8em; font-weight: bold; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; }
        .watch-info-box { background: rgba(255, 255, 255, 0.05); border-left: 3px solid var(--primary); padding: 10px; margin-bottom: 15px; border-radius: 4px; font-size: 0.85em; color: #bbb; }
        .btn-link { display: block; background: #333; color: white; text-decoration: none; padding: 10px; border-radius: 5px; margin-bottom: 8px; font-size: 0.9em; text-align: center; border: 1px solid #444; transition: 0.3s; width: 100%; box-sizing: border-box; font-weight: bold; }
        .btn-link:hover { background: var(--primary); border-color: var(--primary); transform: translateY(-2px); }
        .star-rating { font-size: 1.3em; color: #444; cursor: pointer; margin: 5px 0; text-align: center; display: flex; justify-content: center; }
        .star-rating span.active { color: #f1c40f; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-delete { background: none; color: #ff4757; border: 1px solid #ff4757; padding: 8px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 0.8em; margin-top: 10px; }
        .user-note { background: #222; border: 1px solid #444; padding: 15px; border-radius: 10px; font-size: 0.85em; line-height: 1.5; color: #aaa; margin-top: 15px; }

        @media (max-width: 800px) {
            .top-info { flex-direction: column; align-items: center; }
            .poster { width: 100%; max-width: 300px; }
            .bottom-controls { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">‚Üê Retour au catalogue</a>
        <div id="anime-details">Chargement...</div>

        <div class="comments-section" style="margin-top:20px; background:var(--card-bg); padding:20px; border-radius:15px; border: 1px solid #333;">
            <h3>Commentaires</h3>
            <textarea id="comment-input" style="width: 100%; background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; resize: none; box-sizing: border-box;" placeholder="Ajouter un commentaire..." rows="3"></textarea>
            <button id="btn-post" class="btn-save" style="width: auto; padding: 10px 30px;">Publier</button>
            <div id="comments-display" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, addDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyCD70a-QR2nJnHBnA-FUoIGHZ7Z3VByPMk", authDomain: "le-malicieux-v2.firebaseapp.com", projectId: "le-malicieux-v2", storageBucket: "le-malicieux-v2.firebasestorage.app", messagingSenderId: "938147445933", appId: "1:938147445933:web:86f9c65ee0737e66a9da24" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const params = new URLSearchParams(window.location.search);
        const animeName = params.get('name');
        let currentUser = null;
        let userRating = 0;

        async function load() {
            try {
                const resp = await fetch('animes.csv');
                const data = await resp.text();
                const lines = data.split(/\r?\n/).slice(1);
                
                const anime = lines.map(l => {
                    const c = l.split(';'); 
                    const cl = (s) => s ? s.trim().replace(/^"|"$/g, '') : "";
                    if(cl(c[0]) === animeName) {
                        return { 
                            nom: cl(c[0]), pop: cl(c[1]), score: cl(c[2]), year: cl(c[3]), 
                            ep: cl(c[4]), censure: cl(c[5]), etat: cl(c[6]), desc: cl(c[7]), 
                            img: cl(c[8]), streamLinks: c[9] ? c[9].split(',').map(cl) : [],
                            downloadLinks: c[10] ? c[10].split(',').map(cl) : [],
                            visionnageInfo: cl(c[11])
                        };
                    }
                }).find(x => x);

                if(anime) {
                    // Calcul du nombre d'√©pisodes
                    const matches = anime.ep.match(/\d+/g);
                    const totalEpisodes = matches ? parseInt(matches[matches.length - 1]) : 0;
                    
                    let epOptions = "";
                    for(let i=0; i <= totalEpisodes; i++) {
                        epOptions += `<option value="${i}">${i}</option>`;
                    }

                    document.getElementById('anime-details').innerHTML = `
                        <div class="anime-header">
                            <div class="top-info">
                                <div class="poster">
                                    <img src="img/${anime.img.split('.')[0]}.jpg" onerror="this.src='img/${anime.img.split('.')[0]}.png'">
                                </div>
                                <div class="main-details">
                                    <h1 class="anime-title">${anime.nom}</h1>
                                    <div class="stats-grid">
                                        <div class="stat-item"><small>Pop.</small><span>${anime.pop}</span></div>
                                        <div class="stat-item"><small>Score</small><span>‚≠ê ${anime.score}</span></div>
                                        <div class="stat-item"><small>Ann√©e</small><span>${anime.year}</span></div>
                                        <div class="stat-item"><small>√âpisodes</small><span>${anime.ep}</span></div>
                                        <div class="stat-item"><small>Censure</small><span>${anime.censure}</span></div>
                                        <div class="stat-item"><small>√âtat</small><span>${anime.etat}</span></div>
                                    </div>
                                    <p style="line-height:1.5; color:#ccc; margin:0; font-size:0.9em;">${anime.desc}</p>
                                </div>
                            </div>

                            <div class="bottom-controls">
                                <div class="playlist-box">
                                    <label style="font-size:0.75em; color:var(--primary); font-weight:bold; text-transform:uppercase; display:block; margin-bottom:10px;">Ma Liste</label>
                                    <select id="user-status"><option value="watching">En cours</option><option value="waiting">En attente</option><option value="completed">Termin√©</option></select>
                                    <select id="target-playlist"><option value="">(Par d√©faut)</option></select>
                                    
                                    <div class="ep-select-container">
                                        <span style="color:#aaa; font-size:0.85em;">Vu :</span>
                                        <select id="user-ep">${epOptions}</select>
                                        <span style="color:#aaa; font-size:0.85em;">/ ${totalEpisodes}</span>
                                    </div>

                                    <div class="star-rating" id="stars">${Array.from({length:10}, (_,i)=>`<span data-v="${i+1}">‚òÖ</span>`).join('')}</div>
                                    <button class="btn-save" id="save-btn">Mettre √† jour</button>
                                    <button class="btn-delete" id="delete-btn">Retirer de ma liste</button>
                                </div>

                                <div class="link-box">
                                    <div class="link-title">üì• T√©l√©chargement</div>
                                    <div id="dl-area" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
                                    <div class="link-title" style="margin-top:20px;">üé¨ Visionnage (Nouvel onglet)</div>
                                    <div class="watch-info-box">${anime.visionnageInfo || "Aucune info."}</div>
                                    <div id="stream-area" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;"></div>
                                    
                                    <div class="user-note">
                                        <b>Attention :</b><br>
                                        Quand une ≈ìuvre poss√®de une deuxi√®me saison qui porte le m√™me nom ou un nom tr√®s ressemblant, je cr√©√© une seule carte pour toutes les saisons donc les informations comme la popularit√© sont plus g√©n√©rales, les liens de visionnage et de t√©l√©chargement sont biens pr√©sents, j'ai aussi inclus par exemple pour l'anime Furifure/2, le slash (/) s√©pare la saison 1 de la saison 2. Donc quand vous voyez un slash (/) dans un nom, c'est qu'il y a plusieurs saisons, sauf cas compliqu√©s comme Ikenai Koto o√π ses ses 3 saisons sont en 3 cartes ou Bible Black en une seule. Si ce n'est pas clair n'h√©sitez pas √† poser des questions sur le discord :)
                                    </div>
                                </div>
                            </div>
                        </div>`;

                    const dlArea = document.getElementById('dl-area');
                    anime.downloadLinks.filter(l => l).forEach((link, i) => {
                        dlArea.innerHTML += `<a href="${link}" target="_blank" rel="noopener noreferrer" class="btn-link">Lien ${i+1}</a>`;
                    });

                    const streamArea = document.getElementById('stream-area');
                    anime.streamLinks.filter(l => l).forEach((link, i) => {
                        streamArea.innerHTML += `<a href="${link}" target="_blank" rel="noopener noreferrer" class="btn-link">Lecteur ${i+1} ‚Üó</a>`;
                    });

                    onAuthStateChanged(auth, async (u) => {
                        currentUser = u;
                        if(u) {
                            // Remplissage des playlists
                            onSnapshot(query(collection(db, "playlists_custom"), where("uid", "==", u.uid)), (snap) => {
                                const sel = document.getElementById('target-playlist');
                                if(sel) {
                                    sel.innerHTML = '<option value="">(Par d√©faut)</option>';
                                    snap.forEach(d => {
                                        sel.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`;
                                    });
                                }
                            });

                            // Chargement des donn√©es utilisateur
                            const docRef = doc(db, "playlists", u.uid + "_" + anime.nom);
                            const docSnap = await getDoc(docRef);
                            if(docSnap.exists()) {
                                const d = docSnap.data();
                                if(document.getElementById('user-status')) document.getElementById('user-status').value = d.status || 'watching';
                                if(document.getElementById('user-ep')) document.getElementById('user-ep').value = d.epSeen || 0;
                                userRating = d.rating || 0;
                                updateStars(userRating);
                                if(d.playlistTarget) {
                                    setTimeout(() => { 
                                        const pSel = document.getElementById('target-playlist');
                                        if(pSel) pSel.value = d.playlistTarget; 
                                    }, 800);
                                }
                            }

                            document.getElementById('save-btn').onclick = () => {
                                setDoc(docRef, {
                                    uid: u.uid, anime: anime.nom, img: anime.img, status: document.getElementById('user-status').value,
                                    epSeen: parseInt(document.getElementById('user-ep').value), rating: userRating, 
                                    playlistTarget: document.getElementById('target-playlist').value, epMax: totalEpisodes
                                }).then(() => alert("Sauvegard√© !"));
                            };
                            document.getElementById('delete-btn').onclick = () => { if(confirm("Retirer ?")) deleteDoc(docRef).then(() => location.reload()); };
                        }
                    });

                    const updateStars = (v) => document.querySelectorAll('#stars span').forEach(s => s.classList.toggle('active', s.dataset.v <= v));
                    document.getElementById('stars').onclick = (e) => { if(e.target.dataset.v) { userRating = parseInt(e.target.dataset.v); updateStars(userRating); } };

                    onSnapshot(query(collection(db, "commentaires"), where("anime", "==", animeName)), (snap) => {
                        const cDisp = document.getElementById('comments-display');
                        const docs = [];
                        snap.forEach(d => docs.push(d.data()));
                        docs.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
                        cDisp.innerHTML = docs.map(d => `
                            <div style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                                <b style="color:var(--primary)">${d.userName}</b> <small style="color:#666">${d.date?.toDate().toLocaleDateString() || 'Aujourd\\'hui'}</small>
                                <p style="margin:5px 0; font-size:0.9em;">${d.text}</p>
                            </div>`).join('');
                    });

                    document.getElementById('btn-post').onclick = async () => {
                        if(!currentUser) return alert("Connectez-vous sur l'accueil !");
                        const txt = document.getElementById('comment-input').value;
                        if(txt.trim()) {
                            await addDoc(collection(db, "commentaires"), { anime: animeName, text: txt, userName: currentUser.displayName, date: serverTimestamp() });
                            document.getElementById('comment-input').value = "";
                        }
                    };
                }
            } catch (err) { console.error(err); }
        }
        load();
    </script>
</body>
</html>
