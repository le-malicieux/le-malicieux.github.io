async function load() {
            const display = document.getElementById('anime-details');
            try {
                const resp = await fetch('animes.csv');
                if(!resp.ok) throw new Error("Erreur chargement CSV");
                const data = await resp.text();
                const lines = data.split(/\r?\n/).slice(1);
                
                const anime = lines.map(l => {
                    const c = l.split(';'); 
                    const cl = (s) => s ? s.trim().replace(/^"|"$/g, '') : "";
                    if(cl(c[0]) === animeName) {
                        return { 
                            nom: cl(c[0]), pop: cl(c[1]), score: cl(c[2]), year: cl(c[3]), 
                            ep: cl(c[4]), censure: cl(c[5]), etat: cl(c[6]), desc: cl(c[7]), 
                            img: cl(c[8]),
                            streamLinks: c[9] ? c[9].split(',').map(cl) : [],
                            downloadLinks: c[10] ? c[10].split(',').map(cl) : [],
                            visionnageInfo: cl(c[11])
                        };
                    }
                }).find(x => x);

                if(!anime) {
                    display.innerHTML = "Anime non trouv√©.";
                    return;
                }

                // G√©n√©ration des options du menu d√©roulant (0 √† Max)
                let epOptions = "";
                const max = parseInt(anime.ep) || 0;
                for(let i=0; i<=max; i++) {
                    epOptions += `<option value="${i}">${i}</option>`;
                }

                display.innerHTML = `
                    <div class="anime-header">
                        <div class="top-info">
                            <div class="poster">
                                <img src="img/${anime.img.split('.')[0]}.jpg" onerror="this.src='img/${anime.img.split('.')[0]}.png'">
                            </div>
                            <div class="main-details">
                                <h1 class="anime-title">${anime.nom}</h1>
                                <div class="stats-grid">
                                    <div class="stat-item"><small>Pop.</small><span>${anime.pop}</span></div>
                                    <div class="stat-item"><small>Score</small><span>‚≠ê ${anime.score}</span></div>
                                    <div class="stat-item"><small>Ann√©e</small><span>${anime.year}</span></div>
                                    <div class="stat-item"><small>√âpisodes</small><span>${anime.ep}</span></div>
                                    <div class="stat-item"><small>Censure</small><span>${anime.censure}</span></div>
                                    <div class="stat-item"><small>√âtat</small><span>${anime.etat}</span></div>
                                </div>
                                <p style="line-height:1.5; color:#ccc; margin:0; font-size:0.9em;">${anime.desc}</p>
                            </div>
                        </div>

                        <div class="bottom-controls">
                            <div class="playlist-box">
                                <label style="font-size:0.75em; color:var(--primary); font-weight:bold; text-transform:uppercase; display:block; margin-bottom:10px;">Ma Liste</label>
                                <select id="user-status"><option value="watching">En cours</option><option value="waiting">En attente</option><option value="completed">Termin√©</option></select>
                                <select id="target-playlist"><option value="">Chargement...</option></select>
                                
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; background:#333; padding:5px 10px; border-radius:4px; border:1px solid #555;">
                                    <span style="font-size:0.85em; color:#888;">Vu :</span>
                                    <select id="user-ep" style="background:transparent; border:none; color:white; padding:5px; margin-bottom:0; flex:1;">${epOptions}</select>
                                    <span style="font-size:0.85em; color:#888;">/ ${anime.ep}</span>
                                </div>

                                <div class="star-rating" id="stars">${Array.from({length:10}, (_,i)=>`<span data-v="${i+1}">‚òÖ</span>`).join('')}</div>
                                <button class="btn-save" id="save-btn">Mettre √† jour</button>
                                <button class="btn-delete" id="delete-btn">Retirer</button>
                            </div>

                            <div class="link-box">
                                <div class="link-title">üì• T√©l√©chargement</div>
                                <div id="dl-area" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
                                <div class="link-title" style="margin-top:20px;">üé¨ Visionnage</div>
                                <div class="watch-info-box">${anime.visionnageInfo || "Aucune info."}</div>
                                <div id="stream-area" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;"></div>
                            </div>
                        </div>
                    </div>`;

                // Remplissage des liens
                const dlArea = document.getElementById('dl-area');
                anime.downloadLinks.filter(l => l).forEach((link, i) => {
                    dlArea.innerHTML += `<a href="${link}" target="_blank" class="btn-link">Lien ${i+1}</a>`;
                });

                const streamArea = document.getElementById('stream-area');
                anime.streamLinks.filter(l => l).forEach((link, i) => {
                    streamArea.innerHTML += `<a href="${link}" target="_blank" class="btn-link">Lecteur ${i+1} ‚Üó</a>`;
                });

                // Gestion Firebase (Playlist / Save / Stars)
                onAuthStateChanged(auth, async (u) => {
                    currentUser = u;
                    if(u) {
                        onSnapshot(query(collection(db, "playlists_custom"), where("uid", "==", u.uid)), (snap) => {
                            const sel = document.getElementById('target-playlist');
                            sel.innerHTML = snap.empty ? '<option value="">(Par d√©faut)</option>' : '';
                            snap.forEach(d => sel.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`);
                        });
                        const docRef = doc(db, "playlists", u.uid + "_" + anime.nom);
                        const docSnap = await getDoc(docRef);
                        if(docSnap.exists()) {
                            const d = docSnap.data();
                            document.getElementById('user-status').value = d.status;
                            document.getElementById('user-ep').value = d.epSeen;
                            userRating = d.rating || 0;
                            updateStars(userRating);
                        }
                        document.getElementById('save-btn').onclick = () => {
                            setDoc(docRef, {
                                uid: u.uid, anime: anime.nom, img: anime.img, status: document.getElementById('user-status').value,
                                epSeen: parseInt(document.getElementById('user-ep').value), rating: userRating, 
                                playlistTarget: document.getElementById('target-playlist').value, epMax: anime.ep
                            }).then(() => alert("Sauvegard√© !"));
                        };
                    }
                });

                const updateStars = (v) => document.querySelectorAll('#stars span').forEach(s => s.classList.toggle('active', s.dataset.v <= v));
                document.getElementById('stars').onclick = (e) => { if(e.target.dataset.v) { userRating = parseInt(e.target.dataset.v); updateStars(userRating); } };

            } catch (err) { 
                console.error(err);
                display.innerHTML = "Erreur de chargement.";
            }
        }
