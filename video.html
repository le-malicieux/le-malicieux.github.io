<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionnage - Le Malicieux</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .back-btn { padding: 10px 20px; background: #333; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }
        .back-btn:hover { background: var(--primary); }
        .episode-selector { padding: 10px; border-radius: 5px; background: #222; color: white; border: 1px solid var(--primary); font-size: 16px; }
        .video-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; border: 1px solid #333; }
        iframe { width: 100%; height: 100%; border: none; }
        .details { display: flex; gap: 20px; flex-wrap: wrap; background: #1a1a1a; padding: 20px; border-radius: 15px; border: 1px solid #333; }
        .details img { width: 200px; border-radius: 10px; object-fit: cover; }
        .info { flex: 1; min-width: 300px; }
        h1 { color: var(--primary); margin: 0 0 10px 0; }
        .tag { background: #333; padding: 5px 10px; border-radius: 15px; font-size: 0.85em; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-nav">
            <a href="index.html" class="back-btn">‚Üê Retour</a>
            <div id="selector-container"></div>
        </div>
        <div id="video-wrapper" class="video-container">
            <p style="text-align:center; padding-top:20%;">Recherche de la vid√©o...</p>
        </div>
        <div id="details-content"></div>
    </div>

    <script>
        const clean = (str) => (str || "").replace(/^"|"$/g, "").trim();

        function splitCSVLine(line) {
            const result = [];
            let current = "", inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                let char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ';' && !inQuotes) { result.push(current); current = ""; }
                else current += char;
            }
            result.push(current);
            return result;
        }

        function formatStreamtape(url) {
            if(!url || url.length < 5) return "";
            return url.trim().replace('/v/', '/e/');
        }

        async function initVideo() {
            const params = new URLSearchParams(window.location.search);
            const animeName = params.get('name');

            try {
                const response = await fetch('animes.csv');
                const data = await response.text();
                const rows = data.split(/\r?\n(?=(?:(?:[^"]*"){2})*[^"]*$)/).filter(l => l.trim() !== "");
                
                let found = null;
                for(let i=1; i<rows.length; i++) {
                    let c = splitCSVLine(rows[i]);
                    if (clean(c[0]) === animeName) {
                        found = {
                            nom: clean(c[0]),
                            score: clean(c[2]),
                            eps: clean(c[4]),
                            desc: clean(c[7]),
                            img: clean(c[8]),
                            urls: clean(c[9]).split(',').filter(u => u.trim() !== "")
                        };
                        break;
                    }
                }

                if (found) {
                    // Charger la vid√©o
                    if(found.urls.length > 0) {
                        document.getElementById('video-wrapper').innerHTML = `<iframe id="main-player" src="${formatStreamtape(found.urls[0])}" allowfullscreen></iframe>`;
                        
                        // Menu √©pisodes
                        if (found.urls.length > 1) {
                            let select = `<select class="episode-selector" onchange="document.getElementById('main-player').src=this.value">`;
                            found.urls.forEach((url, i) => {
                                select += `<option value="${formatStreamtape(url)}">√âpisode ${i + 1}</option>`;
                            });
                            select += `</select>`;
                            document.getElementById('selector-container').innerHTML = select;
                        }
                    } else {
                        document.getElementById('video-wrapper').innerHTML = `<p style="text-align:center; padding-top:20%;">Aucune vid√©o disponible pour cet anime.</p>`;
                    }

                    // D√©tails
                    document.getElementById('details-content').innerHTML = `
                        <div class="details">
                            <img src="img/${found.img}" onerror="this.src='https://via.placeholder.com/200x300'">
                            <div class="info">
                                <h1>${found.nom}</h1>
                                <p><span class="tag">‚≠ê ${found.score}/10</span> <span class="tag">üì∫ ${found.eps} √©pisodes</span></p>
                                <p>${found.desc}</p>
                            </div>
                        </div>
                    `;
                }
            } catch(e) { console.error(e); }
        }
        initVideo();
    </script>
</body>
</html>
