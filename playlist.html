<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Malicieux - Ma Playlist</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --card-bg: rgba(20, 20, 20, 0.9); --text: #eee; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; min-height: 100vh; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        .header-box { background: var(--card-bg); padding: 30px; border-radius: 15px; border: 1px solid #333; margin-bottom: 30px; text-align: center; }
        .header-box h1 { color: var(--primary); margin: 0; }
        
        /* Grille identique à l'index */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .card { background: var(--card-bg); border-radius: 8px; overflow: hidden; border: 1px solid #333; text-decoration: none; color: inherit; position: relative; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .card img { width: 100%; height: 250px; object-fit: cover; }
        .card-info { padding: 10px; }
        .status-tag { position: absolute; top: 10px; left: 10px; padding: 4px 8px; border-radius: 4px; font-size: 0.7em; font-weight: bold; background: var(--primary); }
        
        .login-needed { text-align: center; padding: 50px; background: var(--card-bg); border-radius: 15px; border: 1px dashed #555; }
        .btn-google { background: #4285F4; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <a href="index.html" style="color:var(--primary); text-decoration:none; font-weight:bold;">← Retour à l'accueil</a>
    
    <div id="auth-check" class="login-needed" style="display:none;">
        <h2>Veuillez vous connecter</h2>
        <p>Vous devez être connecté pour voir votre playlist personnalisée.</p>
        <button class="btn-google" id="btn-login">Se connecter avec Google</button>
    </div>

    <div id="playlist-content" style="display:none;">
        <div class="header-box">
            <h1 id="user-title">Ma Playlist</h1>
            <p id="stats-summary">Chargement de vos statistiques...</p>
        </div>

        <div class="grid" id="playlist-grid">
            </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Utilise ta config Firebase identique à video.html
    const firebaseConfig = {
        apiKey: "AIzaSyCD70a-QR2nJnHBnA-FUoIGHZ7Z3VByPMk",
        authDomain: "le-malicieux-v2.firebaseapp.com",
        projectId: "le-malicieux-v2",
        storageBucket: "le-malicieux-v2.firebasestorage.app",
        messagingSenderId: "938147445933",
        appId: "1:938147445933:web:86f9c65ee0737e66a9da24"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('auth-check').style.display = 'none';
            document.getElementById('playlist-content').style.display = 'block';
            document.getElementById('user-title').innerText = `Playlist de ${user.displayName}`;
            loadUserPlaylist(user.uid);
        } else {
            document.getElementById('auth-check').style.display = 'block';
            document.getElementById('playlist-content').style.display = 'none';
        }
    });

    async function loadUserPlaylist(uid) {
        const q = query(collection(db, "playlists"), where("uid", "==", uid));
        const querySnapshot = await getDocs(q);
        const container = document.getElementById('playlist-grid');
        container.innerHTML = "";

        let count = 0;
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            if(data.status && data.status !== 'none') {
                count++;
                const card = document.createElement('a');
                card.className = 'card';
                card.href = `video.html?name=${encodeURIComponent(data.anime)}`;
                card.innerHTML = `
                    <div class="status-tag">${data.status.toUpperCase()}</div>
                    <img src="img/${data.anime}.jpg" onerror="this.src='https://via.placeholder.com/180x250'">
                    <div class="card-info">
                        <strong>${data.anime}</strong><br>
                        <span style="color:#f1c40f;">${"★".repeat(data.rating || 0)}</span>
                    </div>
                `;
                container.appendChild(card);
            }
        });
        document.getElementById('stats-summary').innerText = `${count} animes dans votre collection.`;
    }
</script>
</body>
</html>
