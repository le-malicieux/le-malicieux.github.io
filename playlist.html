<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Playlist - Le Malicieux</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --card-bg: #1a1a1a; --text: #eee; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        
        .mal-banner { background: #1a1a1a; border-bottom: 2px solid var(--primary); padding: 20px; display: flex; align-items: center; gap: 20px; }
        .mal-logo { width: 80px; height: 80px; border-radius: 10px; border: 2px solid var(--primary); }
        .mal-titles h1 { margin: 0; color: var(--primary); font-size: 1.8em; }
        .mal-titles p { margin: 5px 0 0; color: #888; font-style: italic; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .btn-back { display: inline-block; margin-bottom: 15px; color: white; text-decoration: none; font-size: 0.9em; opacity: 0.7; }
        .btn-back:hover { color: var(--primary); opacity: 1; }

        .tabs { display: flex; background: #222; border-radius: 5px 5px 0 0; overflow: hidden; border: 1px solid #333; }
        .tab { padding: 12px 20px; cursor: pointer; border-right: 1px solid #333; font-weight: bold; font-size: 0.9em; color: #bbb; transition: 0.3s; }
        .tab.active { background: var(--primary); color: white; }

        .list-table { width: 100%; border-collapse: collapse; background: #1a1a1a; border: 1px solid #333; }
        .list-table thead { background: #111; color: var(--primary); text-transform: uppercase; font-size: 0.7em; }
        .list-table th { padding: 12px; text-align: left; border-bottom: 2px solid #333; }
        .list-table td { padding: 10px; border-bottom: 1px solid #222; font-size: 0.85em; }
        
        .col-img img { width: 45px; height: 65px; object-fit: cover; border-radius: 4px; border: 1px solid #444; }
        .col-title { font-weight: bold; color: white; text-decoration: none; display: block; }
        .col-title:hover { color: var(--primary); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-watching { background: #2ecc71; }
        .status-completed { background: #3498db; }
        .status-waiting { background: #f1c40f; }

        .tag-censure { background: rgba(255,71,87,0.1); color: var(--primary); padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(255,71,87,0.3); font-size: 0.8em; }
        .note-star { color: #f1c40f; font-weight: bold; }
        .bloc-note { color: #aaa; font-style: italic; font-size: 0.9em; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body>

    <div class="mal-banner">
        <img src="img/logo.jpg" class="mal-logo">
        <div class="mal-titles">
            <h1>Le Malicieux</h1>
            <p>Catalogue d'animes malicieux - Ma Liste Personnelle</p>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="btn-back">← Retour au catalogue</a>

        <div class="tabs">
            <div class="tab active" onclick="filterList('all', this)">Tous</div>
            <div class="tab" onclick="filterList('watching', this)">En cours</div>
            <div class="tab" onclick="filterList('completed', this)">Terminé</div>
            <div class="tab" onclick="filterList('waiting', this)">En attente</div>
        </div>

        <table class="list-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Image</th>
                    <th>Titre</th>
                    <th>Ma Note</th>
                    <th>Progression</th>
                    <th>Pop.</th>
                    <th>Score</th>
                    <th>Année</th>
                    <th>Censure</th>
                    <th>État</th>
                    <th>Bloc-note</th>
                </tr>
            </thead>
            <tbody id="list-body"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCD70a-QR2nJnHBnA-FUoIGHZ7Z3VByPMk", authDomain: "le-malicieux-v2.firebaseapp.com", projectId: "le-malicieux-v2", storageBucket: "le-malicieux-v2.firebasestorage.app", messagingSenderId: "938147445933", appId: "1:938147445933:web:86f9c65ee0737e66a9da24" };
        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app); 
        const db = getFirestore(app);

        let userItems = [];

        onAuthStateChanged(auth, async (u) => {
            if (!u) { window.location.href = "index.html"; return; }
            
            const resp = await fetch('animes.csv');
            const csvText = await resp.text();
            const allCSV = csvText.split(/\r?\n/).slice(1).map(l => {
                const c = l.split(';'); const cl = (s) => s ? s.trim().replace(/^"|"$/g, '') : "";
                return { nom: cl(c[0]), pop: cl(c[1]), score: cl(c[2]), sortie: cl(c[3]), epMax: cl(c[4]), censure: cl(c[5]), etat: cl(c[6]) };
            });

            const q = query(collection(db, "playlists"), where("uid", "==", u.uid));
            const s = await getDocs(q);
            
            userItems = [];
            s.forEach(d => {
                const data = d.data();
                const csv = allCSV.find(a => a.nom === data.anime);
                if(csv) userItems.push({ ...data, ...csv });
            });

            renderTable(userItems);
        });

        function renderTable(items) {
            const body = document.getElementById('list-body');
            body.innerHTML = "";
            items.forEach((item, i) => {
                const prog = item.status === 'completed' ? item.epMax : `?`;
                body.innerHTML += `
                <tr>
                    <td style="color:#666">${i+1}</td>
                    <td class="col-img"><img src="img/${item.img}"></td>
                    <td>
                        <span class="status-dot status-${item.status}"></span>
                        <a href="video.html?name=${encodeURIComponent(item.anime)}" class="col-title">${item.anime}</a>
                    </td>
                    <td class="note-star">⭐ ${item.rating}/10</td>
                    <td style="color:#aaa">${prog} / ${item.epMax} ep</td>
                    <td style="color:#888">${item.pop}</td>
                    <td>⭐ ${item.score}</td>
                    <td>${item.sortie}</td>
                    <td><span class="tag-censure">${item.censure}</span></td>
                    <td>${item.etat}</td>
                    <td class="bloc-note" title="${item.tags || ''}">${item.tags || ''}</td>
                </tr>`;
            });
        }

        window.filterList = (status, el) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderTable(status === 'all' ? userItems : userItems.filter(i => i.status === status));
        };
    </script>
</body>
</html>
