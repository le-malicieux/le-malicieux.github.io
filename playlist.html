<div class="container">
    <a href="index.html" class="back-btn">← Retour au catalogue</a>
    <div id="playlist-content" style="display:none;">
        <div class="header-box">
            <h1 id="user-title">Ma Playlist</h1>
            <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
                <select id="filter-status" onchange="renderPlaylist()">
                    <option value="all">Tous</option>
                    <option value="vu">Vus</option>
                    <option value="en-attente">En attente</option>
                </select>
                <select id="sort-playlist" onchange="renderPlaylist()">
                    <option value="nom">Nom A-Z</option>
                    <option value="note">Note max</option>
                </select>
            </div>
        </div>
        <div class="grid" id="playlist-grid"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // (Config identique)
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let userItems = [];

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('playlist-content').style.display = 'block';
            const q = query(collection(db, "playlists"), where("uid", "==", user.uid));
            onSnapshot(q, (snapshot) => {
                userItems = [];
                snapshot.forEach(doc => userItems.push(doc.data()));
                renderPlaylist();
            });
        }
    });

    window.removeAnime = async (name) => {
        if(confirm(`Supprimer ${name} ?`)) await deleteDoc(doc(db, "playlists", `${auth.currentUser.uid}_${name}`));
    };

    window.renderPlaylist = () => {
        const container = document.getElementById('playlist-grid');
        const filter = document.getElementById('filter-status').value;
        const sort = document.getElementById('sort-playlist').value;

        let list = userItems.filter(i => filter === 'all' || i.status === filter);
        if(sort === 'note') list.sort((a,b) => b.rating - a.rating);
        else list.sort((a,b) => a.anime.localeCompare(b.anime));

        container.innerHTML = "";
        list.forEach(a => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="status-tag">${a.status.toUpperCase()}</div>
                <button onclick="removeAnime('${a.anime}')" style="position:absolute; top:5px; right:5px; z-index:10; background:red; color:white; border:none; cursor:pointer;">X</button>
                <a href="video.html?name=${encodeURIComponent(a.anime)}">
                    <img src="img/${a.anime}.jpg" onerror="this.src='https://via.placeholder.com/180x250'">
                    <div class="card-info">
                        <strong>${a.anime}</strong><br>
                        <span style="color:#f1c40f;">${a.rating}/10 ★</span>
                    </div>
                </a>`;
            container.appendChild(card);
        });
    };
</script>
