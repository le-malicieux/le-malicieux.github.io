<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Playlist - Le Malicieux</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --text: #eee; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        .mal-banner { background: #1a1a1a; border-bottom: 2px solid var(--primary); padding: 20px; display: flex; align-items: center; gap: 20px; }
        .mal-logo { width: 80px; height: 80px; border-radius: 10px; border: 2px solid var(--primary); }
        .mal-titles h1 { margin: 0; color: var(--primary); font-size: 1.8em; }
        .container { max-width: 1250px; margin: 20px auto; padding: 0 15px; }
        .tabs { display: flex; background: #222; border-radius: 5px 5px 0 0; border: 1px solid #333; margin-top: 20px; }
        .tab { padding: 12px 20px; cursor: pointer; border-right: 1px solid #333; font-weight: bold; font-size: 0.9em; color: #bbb; }
        .tab.active { background: var(--primary); color: white; }
        .list-table { width: 100%; border-collapse: collapse; background: #1a1a1a; border: 1px solid #333; }
        .list-table thead { background: #111; color: var(--primary); text-transform: uppercase; font-size: 0.7em; }
        .list-table th, .list-table td { padding: 12px; text-align: left; border-bottom: 1px solid #222; }
        .col-img img { width: 45px; height: 65px; object-fit: cover; border-radius: 4px; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-watching { background: #2ecc71; }
        .status-completed { background: #3498db; }
        .status-waiting { background: #f1c40f; }
        .delete-btn { background: none; border: none; color: #ff4757; cursor: pointer; font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="mal-banner">
        <img src="img/logo.jpg" class="mal-logo">
        <div class="mal-titles"><h1>Le Malicieux</h1><p>Ma Liste Personnelle</p></div>
    </div>
    <div class="container">
        <a href="index.html" style="color:white; text-decoration:none;">‚Üê Retour au catalogue</a>
        <div class="tabs">
            <div class="tab active" onclick="filterList('all', this)">Tous</div>
            <div class="tab" onclick="filterList('watching', this)">En cours</div>
            <div class="tab" onclick="filterList('completed', this)">Termin√©</div>
            <div class="tab" onclick="filterList('waiting', this)">En attente</div>
        </div>
        <table class="list-table">
            <thead>
                <tr>
                    <th>#</th><th>Image</th><th>Titre</th><th>Note</th><th>Progr.</th><th>Pop.</th><th>Score</th><th>Ann√©e</th><th>Censure</th><th>√âtat</th><th>Bloc-note</th><th>Action</th>
                </tr>
            </thead>
            <tbody id="list-body"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCD70a-QR2nJnHBnA-FUoIGHZ7Z3VByPMk", authDomain: "le-malicieux-v2.firebaseapp.com", projectId: "le-malicieux-v2", storageBucket: "le-malicieux-v2.firebasestorage.app", messagingSenderId: "938147445933", appId: "1:938147445933:web:86f9c65ee0737e66a9da24" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
        let userItems = [];

        onAuthStateChanged(auth, async (u) => {
            if (!u) return;
            const resp = await fetch('animes.csv'); const csvText = await resp.text();
            const allCSV = csvText.split(/\r?\n/).slice(1).map(l => {
                const c = l.split(';'); const cl = (s) => s ? s.trim().replace(/^"|"$/g, '') : "";
                return { nom: cl(c[0]), pop: cl(c[1]), score: cl(c[2]), sortie: cl(c[3]), epMax: cl(c[4]), censure: cl(c[5]), etat: cl(c[6]) };
            });

            const s = await getDocs(query(collection(db, "playlists"), where("uid", "==", u.uid)));
            userItems = [];
            s.forEach(d => {
                const data = d.data();
                const csv = allCSV.find(a => a.nom === data.anime);
                if(csv) userItems.push({ ...data, ...csv, id: d.id });
            });
            renderTable(userItems);
        });

        function renderTable(items) {
            const body = document.getElementById('list-body'); body.innerHTML = "";
            items.forEach((item, i) => {
                const currentEp = item.status === 'completed' ? item.epMax : (item.epSeen || 0);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${i+1}</td>
                    <td class="col-img"><img src="img/${item.img}"></td>
                    <td><span class="status-dot status-${item.status}"></span><a href="video.html?name=${encodeURIComponent(item.anime)}" style="color:white; text-decoration:none; font-weight:bold;">${item.anime}</a></td>
                    <td style="color:#f1c40f;">‚≠ê ${item.rating}/10</td>
                    <td>${currentEp} / ${item.epMax}</td>
                    <td>${item.pop}</td><td>‚≠ê ${item.score}</td><td>${item.sortie}</td>
                    <td>${item.censure}</td><td>${item.etat}</td>
                    <td style="font-style:italic; color:#aaa; font-size:0.9em;">${item.tags || ''}</td>
                    <td><button class="delete-btn" onclick="removeAnime('${item.id}')">üóëÔ∏è</button></td>`;
                body.appendChild(tr);
            });
        }

        window.removeAnime = async (id) => {
            if(confirm("Supprimer ?")) { await deleteDoc(doc(db, "playlists", id)); location.reload(); }
        };

        window.filterList = (status, el) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); el.classList.add('active');
            renderTable(status === 'all' ? userItems : userItems.filter(i => i.status === status));
        };
    </script>
</body>
</html>
